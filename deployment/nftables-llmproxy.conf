#!/usr/sbin/nft -f
#
# nftables egress filtering for isoproxy
#
# This ruleset restricts the llmproxy user to only DNS and HTTPS traffic,
# logging any other connection attempts for monitoring.
#
# Installation:
#   1. Get llmproxy UID: id -u llmproxy
#   2. Update LLMPROXY_UID below with the actual UID
#   3. sudo cp deployment/nftables-llmproxy.conf /etc/nftables.d/llmproxy.conf
#   4. Include in main config:
#      echo 'include "/etc/nftables.d/llmproxy.conf"' | sudo tee -a /etc/nftables.conf
#   5. sudo nft -f /etc/nftables.conf
#   6. Verify: sudo nft list ruleset | grep llmproxy
#
# Monitoring:
#   Watch for blocked traffic: sudo journalctl -kf | grep llmproxy-blocked
#
# Testing:
#   sudo -u llmproxy curl https://api.anthropic.com  # should work
#   sudo -u llmproxy curl http://example.com         # should fail (HTTP)
#   sudo -u llmproxy nc -v 1.1.1.1 80               # should fail (port 80)
#

# Get the llmproxy user ID
# Run: id -u llmproxy
define LLMPROXY_UID = 999

# Optional: Restrict DNS to known-good resolvers (recommended for paranoid setups)
# Uncomment and customize based on your /etc/resolv.conf
# define DNS_SERVERS = {
#     1.1.1.1,      # Cloudflare Primary
#     1.0.0.1,      # Cloudflare Secondary
#     8.8.8.8,      # Google Primary
#     8.8.4.4,      # Google Secondary
# }

table inet llmproxy_filter {

    chain output {
        type filter hook output priority 0;
        policy accept;

        # Only match traffic from llmproxy user - allow all other users
        meta skuid != $LLMPROXY_UID accept

        # === ALLOWED: Loopback ===
        # Required for binding to 127.0.0.1:9000
        oif lo accept comment "Allow localhost binding"

        # === ALLOWED: DNS ===
        # Required for resolving upstream hostname (e.g., api.anthropic.com)

        # Option A: Allow DNS to any server (simpler)
        udp dport 53 accept comment "Allow DNS queries (UDP)"
        tcp dport 53 accept comment "Allow DNS queries (TCP)"

        # Option B: Restrict to specific DNS servers (more secure)
        # Uncomment and define DNS_SERVERS above to enable
        # ip daddr $DNS_SERVERS udp dport 53 accept comment "Allow DNS to trusted resolvers"
        # ip daddr $DNS_SERVERS tcp dport 53 accept comment "Allow DNS to trusted resolvers"

        # === ALLOWED: HTTPS ===
        # Required for connecting to upstream API
        # Note: This allows HTTPS to ANY destination. The proxy configuration
        # (PROXY_UPSTREAM_BASE) limits actual connections at the application layer.
        tcp dport 443 ct state new,established accept comment "Allow HTTPS connections"

        # === DENIED: Everything else ===
        # Log and block all other traffic from llmproxy user
        log prefix "llmproxy-blocked: " flags all counter drop
    }
}
