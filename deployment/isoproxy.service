[Unit]
Description=Isoproxy - Minimal Anthropic-compatible proxy for Claude Code
After=network.target

[Service]
Type=simple
User=llmproxy
Group=llmproxy
WorkingDirectory=/opt/isoproxy

# Environment variables (or use EnvironmentFile below)
Environment="PROXY_UPSTREAM_BASE=https://api.anthropic.com"
Environment="PROXY_API_KEY=your-api-key-here"
# Environment="PROXY_DEFAULT_MODEL=claude-3-5-sonnet-20241022"
# Environment="PROXY_TIMEOUT=30"

# Alternative: Load from environment file
# EnvironmentFile=-/etc/isoproxy/config.env

# Start the proxy server
ExecStart=/opt/isoproxy/.venv/bin/uvicorn isoproxy.main:app --host 127.0.0.1 --port 9000 --workers 1

# Restart configuration
Restart=on-failure
RestartSec=5s

# Security hardening
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/log/isoproxy
RestrictAddressFamilies=AF_INET AF_INET6
RestrictNamespaces=true
RestrictRealtime=true
RestrictSUIDSGID=true
LockPersonality=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true
SystemCallFilter=@system-service
SystemCallErrorNumber=EPERM

# Resource limits
LimitNOFILE=1024
CPUQuota=50%
MemoryMax=512M

[Install]
WantedBy=multi-user.target
